<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FOCUS+</title>
<!-- NEW: PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a0806">

<style>
body {
  margin: 0;
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #fde992;
}

header {
  background: #0a0806;
  color: #f5fefd;
  padding: 16px;
  font-size: 22px;
  text-align: center;
  font-weight: bold;
}

.page { display: none; padding: 20px; }
.active { display: block; }

.card {
  background: #fde992;
  margin: 15px 0;
  padding: 25px;
  border-radius: 16px;
  font-size: 20px;
  font-weight: 600;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  cursor: pointer;
  text-align: center;
}
.card span { font-size: 30px; display: block; }

.btn {
  width: 100%;
  padding: 16px;
  margin-top: 15px;
  font-size: 18px;
  border: none;
  border-radius: 14px;
  color: #f5fefd;
  cursor: pointer;
}
.blue { background: #5dade2; }
.orange { background: #f9e076; color:#000; }
.green { background: #4b371c; }
.gray { background: #7f8c8d; }

input[type=number], input[type=range] {
  width: 100%;
  padding: 14px;
  font-size: 18px;
  margin: 10px 0 20px;
  border-radius: 10px;
  border: 1px solid #ccc;
}

.timer-display {
  font-size: 40px;
  font-weight: bold;
  margin: 20px 0;
}

#lampPreview {
  font-size: 80px;
  text-align: center;
  margin: 20px 0;
}

#status {
  margin: 12px;
  font-weight: 600;
}
</style>
</head>

<body>

<header>FOCUS+</header>

<!-- Looping Audio -->
<audio id="studySound" src="study_end.wav.lnk" loop></audio>
<audio id="breakSound" src="break_end.wav.lnk" loop></audio>

<div id="status">Status: Idle</div>

<!-- HOME -->
<div id="home" class="page active">
  <div class="card" onclick="showPage('timer')"><span>‚è±</span>Study Timer</div>
  <div class="card" onclick="showPage('light')"><span>üí°</span>Lighting Control</div>
  <div class="card" onclick="showPage('music')"><span>üéµ</span>Music</div>
  <div class="card" onclick="showPage('bluetooth')"><span>üì∂</span>Bluetooth Pairing</div>
  <!-- NEW: Install App Button -->
<button id="installBtn"
        class="btn blue"
        style="display:none"
        onclick="installApp()">
  üì≤ Install FOCUS+
</button>
</div>

<!-- TIMER -->
<div id="timer" class="page">
  <h2>Study Timer</h2>

  <label>Study Time (minutes)</label>
  <input type="number" id="studyTime" value="25">

  <label>Break Time (minutes)</label>
  <input type="number" id="breakTime" value="5">

  <div class="timer-display" id="display">00:00</div>

  <button class="btn green" onclick="startTimer()">Start</button>
  <button class="btn gray" onclick="stopTimer()">Stop</button>
  <button class="btn gray" onclick="stopReminder()">Stop Reminder üîï</button>
  <button class="btn blue" onclick="showPage('home')">‚¨Ö Back</button>
</div>

<!-- LIGHT -->
<div id="light" class="page">
  <h2>Lighting Control</h2>
  <div id="lampPreview">üí°</div>

  <!-- Lamp Modes -->
  <button class="btn blue" onclick="setLampMode('study')">Study Mode</button>
  <button class="btn orange" onclick="setLampMode('rest')">Rest Mode</button>
  <button class="btn green" onclick="setLampMode('calm')">Calm Mode</button>

  <!-- Dimmer Slider -->
  <label>Brightness</label>
  <input type="range" id="brightness" min="0" max="100" value="100" oninput="adjustBrightness(this.value)">

  <button class="btn gray" onclick="showPage('home')">‚¨Ö Back</button>
</div>

<!-- MUSIC -->
<div id="music" class="page">
  <h2>Focus Music</h2>

  <!-- Spotify Login -->
  <button class="btn green" onclick="loginSpotify()">üéµ Login to Spotify</button>
  <!-- NEW: Open Spotify App (mobile only) -->
<button id="openSpotifyAppBtn"
        class="btn green"
        style="display:none"
        onclick="openSpotifyApp()">
  üéß Open in Spotify App
</button>


  <!-- Embed Player -->
  <iframe id="spotifyEmbed"
          style="border-radius:12px"
          src="https://open.spotify.com/embed/playlist/37i9dQZF1DX8NTLI2TtZa6"
          width="100%"
          height="380"
          frameborder="0"
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture">
  </iframe>

  <button class="btn blue" onclick="showPage('home')">‚¨Ö Back</button>
</div>

<!-- BLUETOOTH -->
<div id="bluetooth" class="page">
  <h2>Bluetooth Pairing</h2>

  <button id="bluetoothBtn"
        class="btn blue"
        onclick="connectBluetooth()">
  üîç Scan & Connect
  </button>

  <button class="btn gray" onclick="showPage('home')">‚¨Ö Back</button>
</div>

<script>
/* Page Navigation */
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* Status Updates */
function updateStatus(msg) {
  document.getElementById("status").innerText = "Status: " + msg;
}

/* Timer */
let countdown, timeLeft, isStudy;

function startTimer() {
  clearInterval(countdown);

  stopReminder(); // ensure no sound is playing from previous session

  const study = studyTime.value * 60;
  const rest = breakTime.value * 60;

  timeLeft = study;
  isStudy = true;

  setLampMode('study'); // Auto lamp mode for study
  updateStatus("üìö Study started");
  updateDisplay();

  countdown = setInterval(() => {
    timeLeft--;

    if (timeLeft <= 0) {
      if (isStudy) {
        playSound('studySound');  // loop sound
        timeLeft = rest;
        isStudy = false;
        setLampMode('rest'); // Auto lamp mode for break
        updateStatus("‚òï Break time");
      } else {
        playSound('breakSound');  // loop sound
        clearInterval(countdown);
        updateStatus("‚úÖ Session completed");
      }
    }
    updateDisplay();
  }, 1000);
}

function stopTimer() {
  clearInterval(countdown);
  display.innerText = "00:00";
  stopReminder(); // stop any playing reminder
  updateStatus("‚èπ Session stopped");
}

/* Play Sound */
function playSound(id){
  const audio = document.getElementById(id);
  audio.currentTime = 0;
  audio.play();
}

/* Stop Reminder Sound */
function stopReminder(){
  const studyAudio = document.getElementById('studySound');
  const breakAudio = document.getElementById('breakSound');
  studyAudio.pause(); studyAudio.currentTime=0;
  breakAudio.pause(); breakAudio.currentTime=0;
  updateStatus('üîï Reminder stopped');
}

/* Timer Display */
function updateDisplay() {
  const m = Math.floor(timeLeft / 60);
  const s = timeLeft % 60;
  display.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

/* Lighting Modes */
function setLampMode(mode) {
  const lamp = document.getElementById('lampPreview');
  if(mode==='study'){ lamp.textContent='‚ö™'; lamp.style.color='#FFFFFF'; lamp.style.opacity=1; }
  if(mode==='rest'){ lamp.textContent='üü°'; lamp.style.color='#FFD700'; lamp.style.opacity=0.5; }
  if(mode==='calm'){ lamp.textContent='üîµ'; lamp.style.color='#1E90FF'; lamp.style.opacity=0.7; }
  document.getElementById('brightness').value = lamp.style.opacity*100; // sync slider
  updateStatus('üí° Lamp mode: ' + mode);
}

/* Dimmer Slider */
function adjustBrightness(value){
  const lamp=document.getElementById('lampPreview');
  lamp.style.opacity=value/100;
  lamp.style.fontSize=(50 + value/2)+'px'; // visual size effect
  updateStatus('üí° Brightness: '+value+'%');
}

/* Web Bluetooth */
async function connectBluetooth() {

  /* iOS check */
  if (isIOS()) {
    disableBluetooth(
      "‚ùå Bluetooth not supported on iPhone browsers (Apple restriction)"
    );
    return;
  }

  /* HTTPS check */
  if (!isSecureContextOK()) {
    disableBluetooth(
      "‚ö†Ô∏è Bluetooth requires HTTPS connection"
    );
    return;
  }

  /* Web Bluetooth support check */
  if (!navigator.bluetooth) {
    disableBluetooth(
      "‚ùå Web Bluetooth not supported on this browser"
    );
    return;
  }

  /* Proceed normally (Android Chrome HTTPS) */
  try {
    updateStatus("üîç Searching Bluetooth devices...");
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: ['battery_service']
    });

    updateStatus("üì∂ Connecting to " + device.name);
    await device.gatt.connect();
    updateStatus("‚úÖ Connected to " + device.name);

  } catch (err) {
    console.error(err);
    updateStatus("‚ùå Bluetooth connection cancelled or failed");
  }
}

/* Spotify OAuth */
const clientId = 'YOUR_SPOTIFY_CLIENT_ID'; // Replace with your client ID
const redirectUri = window.location.href.split('#')[0];
const scopes = 'playlist-read-private';

function loginSpotify() {
  const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scopes)}`;
  window.location = authUrl;
}

window.onload = () => {
  if (window.location.hash) {
    const hash = window.location.hash.substring(1).split('&').reduce((acc, cur) => {
      const [key, value] = cur.split('=');
      acc[key] = value;
      return acc;
    }, {});
    
    if (hash.access_token) {
      window.accessToken = hash.access_token;
      updateStatus('‚úÖ Spotify connected!');
      getUserPlaylists();
    }
  }
};

async function getUserPlaylists() {
  try {
    const res = await fetch('https://api.spotify.com/v1/me/playlists', {
      headers: { 'Authorization': 'Bearer ' + window.accessToken }
    });
    const data = await res.json();

    let html = '<select id="playlistSelect" onchange="loadPlaylist(this.value)">';
    data.items.forEach(pl => { html += `<option value="${pl.id}">${pl.name}</option>`; });
    html += '</select>';

    document.getElementById('spotifyEmbed').insertAdjacentHTML('beforebegin', html);
  } catch (err) {
    console.error(err);
    updateStatus('‚ùå Failed to load playlists');
  }
}

function loadPlaylist(id) {
  document.getElementById('spotifyEmbed').src = `https://open.spotify.com/embed/playlist/${id}`;
  updateStatus('üéµ Playlist loaded!');
}
/* ===============================
   NEW: Mobile detection
================================ */
function isMobile() {
  return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

/* Show Spotify App button on mobile */
window.addEventListener('load', () => {
  if (isMobile()) {
    document.getElementById('openSpotifyAppBtn').style.display = 'block';
  }
});

/* ===============================
   NEW: Spotify App ‚Üí Browser fallback
================================ */
function openSpotifyApp() {
  const src = document.getElementById('spotifyEmbed').src;
  const playlistId = src.split('/playlist/')[1]?.split('?')[0];

  if (!playlistId) return;

  window.location = `spotify:playlist:${playlistId}`;

  setTimeout(() => {
    window.location = `https://open.spotify.com/playlist/${playlistId}`;
  }, 1500);
}

/* ===============================
   NEW: PWA Install Banner
================================ */
let deferredPrompt;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installBtn').style.display = 'block';
});

function installApp() {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(() => {
    deferredPrompt = null;
    document.getElementById('installBtn').style.display = 'none';
  });
}

/* ===============================
   NEW: Orientation lock (after install only)
================================ */
function lockOrientation() {
  if (window.matchMedia('(display-mode: standalone)').matches) {
    if (screen.orientation && screen.orientation.lock) {
      screen.orientation.lock('portrait')
        .catch(showOrientationFallback);
    }
  }
}

function showOrientationFallback() {
  const msg = document.getElementById('orientationMsg');
  msg.style.display = 'block';
  setTimeout(() => msg.style.display = 'none', 3000);
}

/* Trigger after user interaction */
document.addEventListener('click', lockOrientation);

/* ===============================
   NEW: Service Worker
================================ */
if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
  navigator.serviceWorker.register('sw.js')
    .then(() => console.log('‚úÖ Service Worker registered'))
    .catch(err => console.log('SW skipped:', err));
}

/* ===============================
   NEW: Bluetooth environment checks
================================ */

/* Detect iOS */
function isIOS() {
  return /iPhone|iPad|iPod/i.test(navigator.userAgent);
}

/* Detect HTTPS */
function isSecureContextOK() {
  return window.isSecureContext;
}

/* Disable Bluetooth button gracefully */
function disableBluetooth(reason) {
  const btn = document.getElementById('bluetoothBtn');
  btn.disabled = true;
  btn.classList.remove('blue');
  btn.classList.add('gray');
  btn.innerText = 'üö´ Bluetooth Unavailable';
  updateStatus(reason);
}

</script>

<!-- NEW: Orientation fallback message -->
<div id="orientationMsg"
     style="display:none;
            position:fixed;
            bottom:20px;
            left:50%;
            transform:translateX(-50%);
            background:#000;
            color:#fff;
            padding:12px 18px;
            border-radius:12px;
            font-size:14px;
            z-index:999;">
  üîÑ Please keep your phone upright for best experience
</div>

</body>
</html>
